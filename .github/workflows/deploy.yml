name: Deploy VSCodium Web

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # Tous les jours à minuit

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --- 1. VSCodium Core ---
      - name: Download & Unpack VSCodium
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Téléchargement VSCodium
          gh release download \
            --repo VSCodium/vscodium \
            --pattern "*vscodium-reh-web-alpine-x64*.tar.gz" \
            --dir vscodium-download \
            --clobber

          # Préparation dossier public
          mkdir -p public
          
          # Extraction
          tar -xzf vscodium-download/*.tar.gz -C public --strip-components=1
                    
          # Nettoyage VSCodium
          rm -rf public/bin vscodium-download

      # --- 2. Extension Start WebContainer ---
      - name: Download & Unpack Extension
        run: |
          # Création du dossier pour l'extension
          mkdir -p public/extensions/start-webcontainer

          echo "Downloading extension from Marketplace..."
          # URL directe pour télécharger la dernière version du VSIX
          # Note: On télécharge le fichier en tant que .zip pour faciliter l'extraction
          curl -L "https://marketplace.visualstudio.com/_apis/public/gallery/publishers/hankei6km/vsextensions/vscode-ext-start-webcontainer/latest/vspackage" | gunzip > extension.zip

          echo "Unzipping extension..."
          # Extraction dans un dossier temporaire
          unzip -q extension.zip -d ext_temp
          
          # Le code de l'extension se trouve TOUJOURS dans un sous-dossier nommé 'extension' dans le VSIX
          # On déplace le contenu de ce sous-dossier vers notre dossier public final
          cp -r ext_temp/extension/* public/extensions/start-webcontainer/
          # --- FIX 1: Create missing NLS file ---
          echo "{}" > public/extensions/start-webcontainer/package.nls.json

          # --- FIX 2: REMOVE "type": "module" ---
          # This fixes the "ESM modules are not supported" error.
          # We use grep to exclude the line containing "type": "module"
          sed -i '/"type": "module",/d' public/extensions/start-webcontainer/package.json
          curl -L -o public/coi-serviceworker.min.js "https://cdn.jsdelivr.net/npm/coi-serviceworker@0.1.7/coi-serviceworker.min.js"

          # Nettoyage
          rm extension.zip
          rm -rf ext_temp
          
          echo "Extension installed in public/extensions/start-webcontainer"

      # --- 3. Déploiement ---
      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './public'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4